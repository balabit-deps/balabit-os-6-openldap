From f120d0e461178b5974694876ba2d2bdba4f7d122 Mon Sep 17 00:00:00 2001
From: Howard Chu <hyc@openldap.org>
Date: Wed, 19 Jun 2019 12:29:02 +0100
Subject: [PATCH] ITS#9038 restrict rootDN proxyauthz to its own DBs.

Treat as normal user for any other DB.
---
 servers/slapd/saslauthz.c |   11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

Index: openldap-2.4.42+dfsg/servers/slapd/saslauthz.c
===================================================================
--- openldap-2.4.42+dfsg.orig/servers/slapd/saslauthz.c	2019-07-26 13:27:42.634285524 -0400
+++ openldap-2.4.42+dfsg/servers/slapd/saslauthz.c	2019-07-26 13:27:42.630285509 -0400
@@ -2059,12 +2059,13 @@ int slap_sasl_authorized( Operation *op,
 		goto DONE;
 	}
 
-	/* Allow the manager to authorize as any DN. */
-	if( op->o_conn->c_authz_backend &&
-		be_isroot_dn( op->o_conn->c_authz_backend, authcDN ))
+	/* Allow the manager to authorize as any DN in its own DBs. */
 	{
-		rc = LDAP_SUCCESS;
-		goto DONE;
+		Backend *zbe = select_backend( authzDN, 1 );
+		if ( zbe && be_isroot_dn( zbe, authcDN )) {
+			rc = LDAP_SUCCESS;
+			goto DONE;
+		}
 	}
 
 	/* Check source rules */
